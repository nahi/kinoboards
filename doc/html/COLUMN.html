<?xml version="1.0" encoding="ISO-2022-JP"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:kb="http://www.jin.gr.jp/xmlns/kb-html-embedding"
    lang="ja" xml:lang="ja">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<link rev="MADE" href="mailto:nakahiro@sarion.co.jp" />
<link rel="INDEX" href="./" />
<link rel="StyleSheet" href="kinoStyle.css" type="text/css" media="screen" />
<title>Column - KINOBOARDS/1.0R7</title>
</head>
<body>

<div class="header">
<h1>
Column
</h1>

<p class="status">
Last modified: July 1, 2000<br />
Created: May 10, 2000
</p>
</div>

<hr />

<div class="main">
<h2>0. このドキュメントの目的</h2>

<p>
このドキュメントは，きのぼずのサポート掲示板やきのぼずメイリングリストに流れたメッセージの一部を，個々独立したコラムとして掲載したものです
（そのままの場合もありますが，大抵は若干編集してあります）．
</p>

<p>
本来なら
<a href="index.html#docs">各種ドキュメント</a>
の一部として整理すべきなんですが，現時点でうまく整理しきれないものが，とりあえずここに置かれているのだと考えてください．^^;
</p>

<p>
本文書が対象としているKINOBOARDSのバージョンは，
KINOBOARDS version 1.0 release 7（KINOBOARDS/1.0R7.2）
です．
</p>

<p>
以下のコラムがあります．
</p>

<ol>
<li><a href="#authentication">R7における認証方式</a></li>
<li><a href="#authentication.r7.1">R7.0〜R7.1.1における認証方式</a></li>
<li><a href="#heavy">R7は重いか?</a></li>
</ol>

<h2 id="authentication">1. R7における認証方式</h2>

<p>
出典: [kb-dev:10543] in 2000/6/27
</p>

<p>
[kb-dev:10503]〜[kb-dev:10543]において，「CGI security consideration」というSubjectで，きのぼずの認証方式の安全性についての議論がありました．
その議論を踏まえ，R7.2において認証方式の変更を行ないました．
</p>

<p>
議論の結果として方式を変更した今でも，
<a href="#authentication.r7.1">R7.0〜R7.1.1の認証方式</a>
は，CGIでの利用に限れば充分に安全だと考えています．
ユーザ権限とセッション権限を分離し，パスワードを極力どこにも残さないようにすることにより，盗まれる権限をセッション権限に留め，復旧が容易です．
しかしこの方法は，ひとたびサーバ側がcrackされると（例え盗まれるのがセッション権限のみであろうと）<strong>全ユーザ</strong>のセッション権限が盗まれてしまう，という欠点を持っているのも事実でした．
今回の変更は，従来からの上記セキュリティ設計の方針を崩さず，この欠点の解消を狙ったものです．
</p>

<p>
具体的には，サーバ側で管理する各ユーザ毎の認証情報を2重化することで，
サーバ側がcrackされても，いきなりセッション権限を盗まれないようになっています(*)．
この変更により，ログイン済みユーザがアクセスする度にダイジェストの計算をしなければならない（従来は完全一致の比較のみだった）ため，若干速度が低下しています．
</p>

<p>
(*) brute forthアタック（ありそうなパスワードを推測し，しらみつぶしに攻撃する方法）で突破され，セッション権限やユーザ権限が盗まれる可能性は残っています．
この攻撃に対する安全性は，OSが提供しているダイジェスト関数の安全性に依存しています．
</p>


<p>
この方式ももちろん，完全ではありません．
クライアント側でHTTP-Cookiesを盗めば，セッション権限（ユーザ権限ではない）を盗めますし，相変わらず，ネットワークを見張られたらユーザ権限も盗まれます．
CGIのみで実現できるセキュリティレベルには限界があります．
必要な場合は，適宜IPレベルでの暗号化，署名，第三者機関による認証などを組み合わせてください．
</p>

<p>
．．．とはいえ，パスワードとセッションキーの2本立てなんて面倒なことをしている以上，もう少し安全にできそうな気がしてます．．．
</p>

<p>
以下，新認証方式の説明です．
</p>

<p>
ユーザがユーザIDとパスワードを入力してログインする時に，
セッションキーを割り当てます．以下，説明を簡単にするため，
ユーザIDについては考えないものとします．
</p>

<pre>
  パスワード: p
  セッションキー: k
  一方向関数: f
  一方向関数用キー: s
  パスワードのダイジェスト: pd = f( s, p )
  セッションキーのダイジェスト: kd = f( s, k )
</pre>

<p>
において，ユーザの頭の中にp，ユーザのマシン（クライアント）にk，
サーバにsおよびpd, kdを保存します．
</p>

<p>
ある時ユーザから，情報Xが入力されます．
ここでXは，pかもしれませんし，kかもしれません．
ログイン判定は，
</p>

<pre>
  f( s, X ) = pd ... (1)
  f( s, X ) = kd ... (2)
</pre>

<p>
のいずれかで成功するものとします．
</p>

<p>
(1)で成功した場合，新たにsおよびkを生成し，それを元にpdとkdを再計算し，
サーバに保存します．クライアントにはkを送ります
（以後，HTTP-CookiesもしくはURL文字列として送信されるように）．
</p>

<p>
(2)で成功した場合は，特になにもしません．
</p>

<p>
Xで，pとkのどちらでもアリ，ということにしているのが若干不安かな．
ここを付いた穴がありそうな気がするんですが，
なひには今のところ思いついてません．．．
</p>

<h2 id="authentication.r7.1">2. R7.0〜R7.1.1における認証方式</h2>

<p>
出典: [kb-dev:10456] in 2000/5/10
</p>

<p>
本コラムで議論している認証方式は，R7.0〜R7.1.1で使われていた方式です．
R7.2以降で用いられている認証方式については，
<a href="#authentication">R7における認証方式</a>をごらんください．
</p>

<p>
まず先に，前提となるメッセージダイジェストについての知識を．
</p>

<blockquote><p>
メッセージ + キー → ダイジェスト
</p></blockquote>

<p>
（※キーは一つとは限りません．
メッセージダイジェスト計算アルゴリズムによっては，2つのキーを使ったりします．）
</p>

<p>
ここで「→」がメッセージダイジェスト計算アルゴリズムなんですが，逆方向の変換はできません（できちゃうと問題です）．
また，写像の関係は多対1です．つまり，複数の「メッセージ + キー」が，同じ「ダイジェスト」になることがあり得ます．
</p>

<p>
以上を踏まえて，cgi.plでやっている認証方法を解説します．
</p>

<p>
まず，ユーザにパスワードを入力させます．
このパスワードが，上記式における「メッセージ」に相当します．
システムは適当なキーを生成し，このパスワードのダイジェストを計算します．
サーバ側（kb.user）には，キーとダイジェストを保存します．
クライアント側（HTTP-Cookiesもしくはウェブページのリンク）には，ダイジェストを打ち込みます．
生パスワードは破棄します．
きのぼずの通常のログレベルであれば，サーバ側のどこにも残りません．
</p>

<p>
ユーザがアクセスしてきた時に，サーバ側，クライアント側のダイジェストが一致すれば認証成功です．
この時，定義より，偶然の一致でダイジェストが一致してしまう可能性が考えられます．
その可能性は，きのぼずが使っているメッセージダイジェスト計算アルゴリズム次第ですが，一般には2^(-56) = 0.00000000000000001387です．
この確率で別ユーザの権限を取得することができます．
きのぼずはメッセージダイジェスト計算アルゴリズムとして，Perlに提供されているもの（crypt）をそのまま利用しています．
PerlはOSに提供されているものをそのまま利用しています．
つまり，OS次第です．
</p>

<p>
ログイン時に，ユーザが生パスワードを入力する場合は，サーバ側で保存してあるキーを使って，そのパスワードのダイジェストを計算します．
これが，サーバ側に保存してあるダイジェストと一致すれば認証成功です．
この時，念のため，新たにキーを生成しています．
これにより，ログインする度に，それ以前にブラウザに打ち込まれたダイジェストが無効になります
（キーが変わるとダイジェストも変わるので，認証に失敗するようになります）．
このため，仮に他人にユーザ権限を取得されてしまったとしても(*)，以後ログインし直せば再び安全な状態に戻ります(**)．
</p>

<p>
(*) 他人にユーザ権限を取得されてしまうパターンとしては，以下のものが考えられます．
</p>

<ul>
<li>サーバ側で，きのぼずのデータファイル（kb.user）を盗まれる．</li>
<li>クライアント側で，HTTP-Cookiesやbookmark，キャッシュを盗まれる．</li>
<li>2^(-56)の確率でダイジェストが一致してしまう．</li>
</ul>

<p>
このうち，攻撃する側にとって一番やり易いのが，「サーバ側で盗む」です．
きのぼずのデータファイルの設置には，充分に注意してください．
</p>

<p>
(**) R7.0以前の実装では，乗っ取られた時にパスワードを変更されてしまうという危険がありました．
R7.1以降では，現在の生パスワードを知らないとパスワードを変更できなくなっていますので，この点での問題はありません．
</p>

<p>
きのぼずでは以上のような実装方法により，生のパスワードを（ユーザの頭の中以外の）どこにも保存することなく，CGIレベルでは最高レベルの安全な認証を実現しています．
</p>

<p>
もちろん，これが完全だという意味ではありません．
より安全にするためには，例え破棄されるとしても，サーバには生パスワードを渡してはいけませんし，また通信路も暗号化する必要があります．
が，これをOSやウェブサーバ，ネットワークのサポートなしに，CGIのみで実現するのは非常にコストが高くかつ無駄であり，きのぼずで要求されるセキュリティレベルを考慮すれば，これで充分だと考えています．
</p>

<h2 id="heavy">3. R7は重いか?</h2>

<p>
出典: [kb-dev:10460] in 2000/5/10
</p>

<p>
R7になってから妙に重くなった気がする，というコメントをもらっています．
</p>

<p>
プロファイラ
（Perlの各関数を何度呼び出して，それぞれどのくらい時間がかかっているかなどのプロファイルをチェックするプログラム）
でチェックしているのですが，その限りでは，CGIプログラムそのものは，R6と有意な差はないように見えます．
</p>

<p>
とはいえ，確かに重くなっているかもしれません．
考えられる原因の第一は，XHTML-Strict化したこと．
いろんなエレメントやアトリビュートが増えたせいで，ページのサイズが結構増えてます．
正確には測ってませんが，平均で下手すると2割くらい増えてるんじゃないかな．．．
</p>

<p>
もしあなたが，きのぼずをいつもadmin権限で利用している場合は注意してください．
admin用のタイトル一覧は，管理用のコマンドがわらわら出てくるので，一般ユーザのタイトル一覧画面にくらべると倍くらいのサイズのXHTMLを生成してしまいます．
普段は一般ユーザとしてアクセスしたほうがいいかもしれません．
</p>

<p>
第二の原因は，CSS化したこと．
クライアント側でCSSのレンダリングに時間がかかる可能性があります．
複雑なcascadingを使うと，ページを読んでから画面に表示するまでに，若干時間がかかるように感じられるかもしれません．
例えばW3Cのサイトから，サンプルCSSファイルなんかをとってくると，その傾向は顕著になります．すげー複雑（というかでかい）ので．．．
</p>

<p>
第三の原因は，本体のプログラム（index.cgi）が長くなったこと．
R6.10と比べて91KB→182KBに増えてます．
その分，起動時にPerlのコンパイラがきのぼずを解析するのにかかる時間も増えます．
</p>

<p>
R6に比べて重くなった原因として今のところ思いつくのは，上記3点です．
</p>

</div>

<hr />

<div class="footer">
<address>
<a href="http://www.jin.gr.jp/~nahi/kb/">KINOBOARDS: Kinoboards Is Network Opened BOARD System</a>.<br />
Copyright &copy; 1995-2000
<a href="http://www.jin.gr.jp/~nahi/">NAKAMURA, Hiroshi</a>.
</address>
</div>
</body>
</html>